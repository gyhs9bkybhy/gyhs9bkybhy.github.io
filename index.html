<!Doctype html>
<html>
    <head>
        <title> Timeline</title>
        <script src = 'https://d3js.org/d3.v5.min.js'> </script>
        <script src = 'https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js'> </script>
    </head>

    <body>
        <div style = 'width: 1080px;'> <!---in html we use xxx px, in javascipt we only use xxx, don't add px--> 
            <h1  text-align = 'center' style = 'font-size: 40px'> Timeline of Covid-19 </h1>
            <p style = 'font-size: 20px'> From 2020, Covid-19, which was initially called Corona Virus, started spreading. 
                The first case was reported in China in January, quickly raising public concern and the attention of the centeral government. 
                Later, Covid-19 spreaded to other countries in Asia, and then to other continents.
                <br><br>
                This global pandemic is highly contagious and long-lasting, causing wide-spread panic and many people to lose their lives. 
                Apart from that, it also indirectly had destructive impacts on the global enconomy. Many business like travelling and resturants 
                have been closed and many people lost their jobs.
                <br><br>
                In this narrative visualization, we will go through the timeline globally and then drill down to the country-level to see 
                the situations of specific countries.  
            </p>
            <p style = 'color: Tomato'>(Click the button at the bottom to drill down to country-level)</p>
            <div style = 'width: 720px; float: left;'>
                <h2> Global Timeline </h2>
                <svg id = 'mainsvg' width = '720' height = '600'></svg>
                <button onclick="location.href='drilldown.html'" type="button" 
                    style = 'margin: 10px;
                    font-weight: 400;
                    text-align: center;
                    white-space: nowrap;
                    vertical-align: middle;
                    border: 1px solid transparent;
                    padding: 6px 12px;
                    font-size: 16px;
                    line-height: 1.42857143;
                    border-radius: 4px;
                    color: #fff;
                    background-color: #337ab7;
                    border-color: #2e6da4;'> Drill down to country level </button>
            </div>
            <div style = 'margin-left: 720px; background-color:rgba(105, 102, 102, 0.144)'>
                <h2> Important Events </h2>
                <p id = 'p_event'  style = 'color: Tomato'> (Click the Line Chart to See Events on the selected Date.) </p>
            </div>
        </div>
        <script> 

            // Some parameters 
            const margin = {top: 50, left: 100, bottom: 60, right: 50};
            const svgwidth = d3.select('#mainsvg').attr('width');
            const svgheight = d3.select('#mainsvg').attr('height');
            const innerwidth = svgwidth - margin.left - margin.right; // This is 
            const innerheight = svgheight - margin.top - margin.bottom;

            var xScale, yScale;
            const duration = 100; // set the duration of transition to 100ms
            var p_event = document.getElementById('p_event');

            let worlddata = []; // use this to store the total_cases in the world
            let eventdata = []; // use this to store the events happen on that date
            let date_lst = [];
            let country_lst = []
            
            // This is the function for plotting the line chart
            var LineChart = function(data){


                // xscale is for date
                xScale = d3.scaleTime()
                .domain(d3.extent(data, d => d.date))
                .range([0, innerwidth]);

                // yscale is for total confirmed cases in the world
                yScale = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.total_cases)].reverse())
                .range([0, innerheight]);

                // here is another new scale for the bars for display
                let barScale = d3.scaleBand()
                .domain(data.map(d => d.date))
                .range([0, innerwidth]);

                let g_line = d3.select('#mainsvg')
                .append('g')
                    .attr('id', 'linechart')
                    .attr('transform', `translate(${margin.left}, ${margin.top})`);

                let xAxis = d3.axisBottom(xScale)
                    .tickFormat(d3.timeFormat('%y/%m'));
                let yAxis = d3.axisLeft(yScale);

                let g_xAxis = g_line.append('g').call(xAxis)
                .attr('id', 'xaxis')
                .attr('transform', `translate(0, ${innerheight})`)
                .append('text')
                    .attr('font-size', '2em')
                    .attr('x', 300)
                    .attr('y', 50)
                    .attr('fill', '#333333')
                    .text('Date');

                let g_yAxis = g_line.append('g').call(yAxis)
                .attr('id', 'yaxis')
                .append('text')
                    .attr('font-size', '2em')
                    .attr('transform', 'rotate(-90)')
                    .attr('x', -140)
                    .attr('y', -80)
                    .attr('fill', '#333333')               
                    .text('# Confirmed Cases');

                let linefunc = d3.line()
                    .x(d => xScale(d.date))
                    .y(d => yScale(d.total_cases));

                let line = g_line.append('path')
                    .attr('id', 'line')
                    .datum(data)
                    .attr('d', linefunc)
                    .attr('stroke', 'steelblue')
                    .attr("stroke-width", 1.5)
                    .attr("stroke-linejoin", "round")
                    .attr("stroke-linecap", "round")
                    .attr('fill', 'none')
                    .style('opacity', 0.8);

                const tooltip = d3.select('body').append('div')
                    .attr('class', 'tooltip')
                    .style('opacity', 0)
                    .style('position', 'absolute');
                
                // now what i want is vanoid, when every point relates to a opaque bar for selection
                g_line.selectAll('rect')
                    .data(data)
                    .enter()
                    .append('rect')
                        .attr('x', d => xScale(d.date) - 0.49 * barScale.bandwidth())
                        .attr('y', 0)
                        .attr('width', 5 * barScale.bandwidth())
                        .attr('height', innerheight)
                        .attr('fill', 'red')
                        .style('opacity', 0)
                        .on('mouseover', function(d) { // pay attention => can't define this, has be to function(d)
                            d3.select(this)
                            .style('opacity', 0.3);
                            
                            // the text for tooptip: date & total cases
                            const tiptext = 'Date: ' + d.date.toLocaleDateString() + '<br>' + 'Total Cases: ' + d.total_cases.toString();
                            // raise the tooltip around the mouse
                            tooltip.html(tiptext)
                            .style('opacity', 1)
                            .style('top', (event.pageY - 100) + 'px')
                            .style('left', (event.pageX - 100) + 'px');

                        })
                        .on('mouseout', function(d) {
                            d3.select(this)
                            .style('opacity', 0);

                            tooltip.html('')
                            .style('opacity', 0);

                        })
                        .on('click', function(d) {
                            
                            // update the event on that date
                            date_idx = eventdata.map(d => +d.date).indexOf(+d.date);

                            if (date_idx === -1){
                                event_para(d.date, 'There is no updated information on the selected date. Please try another one.');
                            }
                            else{
                                event_para(d.date, eventdata[date_idx].event);
                            }
                            p_event.style = 'color: black;'
                        });

                // add annotations
                const annotations = [
                    {
                        note: {
                            label: '1st wave in China'
                        },
                        color: ['red'],
                        x: xScale(new Date(2020, 0, 22)),
                        y: yScale(557),
                        dy: -40,
                        dx: 5
                    },

                    {
                        note: {
                            label: '1st wave in the US'
                        },
                        color: ['dodgerblue'],
                        x: xScale(new Date(2020, 2, 15)),
                        y: yScale(169263),
                        dy: -90,
                        dx: 25
                    },

                    {
                        note: {
                            label: '2nd wave in the US'
                        },
                        color: ['dodgerblue'],
                        x: xScale(new Date(2020, 6, 1)),
                        y: yScale(10675535),
                        dy: -80,
                        dx: 20
                    },

                    {
                        note: {
                            label: '3rd wave in the US'
                        },
                        color: ['dodgerblue'],
                        x: xScale(new Date(2020, 11, 1)),
                        y: yScale(64024799),
                        dy: 20,
                        dx: 30
                    },

                    {
                        note: {
                            label: '2nd wave in India'
                        },
                        color: ['orange'],
                        x: xScale(new Date(2021, 1, 15)),
                        y: yScale(109229028),
                        dy: 20,
                        dx: 30
                    }
                ]                
                const makeAnnotations = d3.annotation().annotations(annotations);
                
                d3.select('#mainsvg')
                  .append('g')
                  .attr('transform', `translate(${margin.left}, ${margin.top})`)
                  .call(makeAnnotations);
            }

            // This is the function for the setting of p_event
            var event_para = function(date, event_info){

                p_event.innerHTML = date.toLocaleDateString() + '</br>' + event_info;
            }

            async function scene1(){
                
                // Load the confirmed data
                let load_world = await d3.csv("world.csv").then(data => {
                    data.forEach(d => {
                        d.date = new Date(d.date);
                        d.total_cases = +(d.total_cases);
                        
                    });
                    worlddata = data;

                    
                });

                // Load the event data
                let load_event = await d3.csv("timeline.csv").then(data => {
                    data.forEach(d => {
                        d.date = new Date(d.date);
                        d.event = d.event.replaceAll('\n', '<br><br>')
                        
                    });
                    eventdata = data;

                    
                });

                LineChart(worlddata);

            };
            
            scene1();

            
        </script>
    </body>
</html>