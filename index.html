<!Doctype html>
<html>
    <head>
        <title> Scene 1: Timeline</title>
        <script src = 'https://d3js.org/d3.v5.min.js'> </script>
        <script src = > </script>
    </head>

    <body>
        <button onclick="location.href='scene2_scatter.html'" type="button"> Next Page </button>
        <div style = 'width: 1200;'>
            <div style = 'width: 900; float: left;'>
                <svg id = 'mainsvg' width = '1200' height = '900'></svg>
            </div>
            <div style = 'margin-left: 300'>
                <p id = 'p_event'> Mouse Over the Line Chart to See Events on the selected Date. </p>
            </div>
        </div>
        <script> 

            // Some parameters 
            const margin = {top: 100, left: 70, bottom: 30, right: 50};
            const svgwidth = d3.select('#mainsvg').attr('width');
            const svgheight = d3.select('#mainsvg').attr('height');
            const innerwidth = svgwidth - margin.left - margin.right; // This is 
            const innerheight = svgheight - margin.top - margin.bottom;

            var xScale, yScale;
            const duration = 100; // set the duration of transition to 100ms
            var p_event = document.getElementById('p_event');

            let worlddata = []; // use this to store the total_cases in the world
            let eventdata = []; // use this to store the events happen on that date
            let date_lst = [];
            let country_lst = []
            
            // This is the function for plotting the line chart
            var LineChart = function(data){
                
                p_event.innerHTML = 'Mouse Over the Line Chart to See Events on the selected Date'; // initialize the event into

                // xscale is for date
                xScale = d3.scaleTime()
                .domain(d3.extent(data, d => d.date))
                .range([0, innerwidth]);

                // yscale is for total confirmed cases in the world
                yScale = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.total_cases)].reverse())
                .range([0, innerheight]);

                // here is another new scale for the bars for display
                let barScale = d3.scaleBand()
                .domain(data.map(d => d.date))
                .range([0, innerwidth]);

                let g_line = d3.select('#mainsvg')
                .append('g')
                    .attr('id', 'linechart')
                    .attr('transform', `translate(${margin.left}, ${margin.top})`);

                let xAxis = d3.axisBottom(xScale);
                let yAxis = d3.axisLeft(yScale);

                let g_xAxis = g_line.append('g').call(xAxis)
                .attr('id', 'xaxis')
                .attr('transform', `translate(0, ${innerheight})`);

                let g_yAxis = g_line.append('g').call(yAxis)
                .attr('id', 'yaxis');

                let linefunc = d3.line()
                    .x(d => xScale(d.date))
                    .y(d => yScale(d.total_cases));

                let line = g_line.append('path')
                    .attr('id', 'line')
                    .datum(data)
                    .attr('d', linefunc)
                    .attr('stroke', 'steelblue')
                    .attr("stroke-width", 1.5)
                    .attr("stroke-linejoin", "round")
                    .attr("stroke-linecap", "round")
                    .attr('fill', 'none')
                    .style('opacity', 0.8);

                const tooltip = d3.select('body').append('div')
                    .attr('class', 'tooltip')
                    .style('opacity', 0)
                    .style('position', 'absolute');
                
                // now what i want is vanoid, when every point relates to a opaque bar for selection
                g_line.selectAll('rect')
                    .data(data)
                    .enter()
                    .append('rect')
                        .attr('x', d => xScale(d.date) - 0.49 * barScale.bandwidth())
                        .attr('y', 0)
                        .attr('width', 5 * barScale.bandwidth())
                        .attr('height', innerheight)
                        .attr('fill', 'red')
                        .style('opacity', 0)
                        .on('mouseover', function(d) { // pay attention => can't define this, has be to function(d)
                            d3.select(this)
                            .style('opacity', 0.3);
                            
                            // the text for tooptip: date & total cases
                            const tiptext = 'Date: ' + d.date.toLocaleDateString() + '<br>' + 'Total Cases: ' + d.total_cases.toString();
                            // raise the tooltip around the mouse
                            tooltip.html(tiptext)
                            .style('opacity', 1)
                            .style('top', (event.pageY - 100) + 'px')
                            .style('left', (event.pageX - 100) + 'px');

                            // update the event on that date
                            date_idx = eventdata.map(d => +d.date).indexOf(+d.date);

                            if (date_idx === -1){
                                event_para('There is no updated information on the selected date. Please try another one.');
                            }
                            else{
                                event_para(eventdata[date_idx].event);
                            }
                            

                        })
                        .on('mouseout', function(d) {
                            d3.select(this)
                            .style('opacity', 0);

                            tooltip.html('')
                            .style('opacity', 0);

                            p_event.innerHTML = 'Mouse Over the Line Chart to See Events on the selected Date';
                        });
            }

            // This is the function for the setting of p_event
            var event_para = function(event_info){
                p_event.style = "margin-left:" + (0).toString() + 'px;'
                                + "margin-top:" + (margin.top).toString() + 'px;';

                p_event.innerHTML = event_info;
            }

            async function scene1(){
                
                // Load the confirmed data
                let load_world = await d3.csv("world.csv").then(data => {
                    data.forEach(d => {
                        d.date = new Date(d.date);
                        d.total_cases = +(d.total_cases);
                        
                    });
                    worlddata = data;

                    
                });

                // Load the event data
                let load_event = await d3.csv("timeline.csv").then(data => {
                    data.forEach(d => {
                        d.date = new Date(d.date);
                        d.event = d.event.replaceAll('\n', '<br><br>')
                        
                    });
                    eventdata = data;

                    
                });

                LineChart(worlddata);

            };
            
            scene1();

            
        </script>
    </body>
</html>